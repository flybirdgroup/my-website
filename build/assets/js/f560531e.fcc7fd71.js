"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1225],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),p=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(o.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),u=r,f=c["".concat(o,".").concat(u)]||c[u]||m[u]||l;return n?a.createElement(f,i(i({ref:t},d),{},{components:n})):a.createElement(f,i({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=c;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},69254:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={id:"Attention",title:"\u53cc\u5411\u6ce8\u610f\u529bLSTM\u795e\u7ecf\u7f51\u7edc",author:"\u62db\u6653\u8d24",author_title:"AI Engineer",author_url:"https://github.com/flybirdgroup",author_image_url:"https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=1615738601,1434436036&fm=26&gp=0.jpg",tags:["CNN","classifier","textCNN"]},i=void 0,s={permalink:"/blog/2020/3/19/attention",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2020-3-19-attention.md",source:"@site/blog/2020-3-19-attention.md",title:"\u53cc\u5411\u6ce8\u610f\u529bLSTM\u795e\u7ecf\u7f51\u7edc",description:"\u539f\u7406\u8bb2\u89e3",date:"2020-03-19T00:00:00.000Z",formattedDate:"March 19, 2020",tags:[{label:"CNN",permalink:"/blog/tags/cnn"},{label:"classifier",permalink:"/blog/tags/classifier"},{label:"textCNN",permalink:"/blog/tags/text-cnn"}],readingTime:9.09,hasTruncateMarker:!0,authors:[{name:"\u62db\u6653\u8d24",title:"AI Engineer",url:"https://github.com/flybirdgroup",imageURL:"https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=1615738601,1434436036&fm=26&gp=0.jpg"}],frontMatter:{id:"Attention",title:"\u53cc\u5411\u6ce8\u610f\u529bLSTM\u795e\u7ecf\u7f51\u7edc",author:"\u62db\u6653\u8d24",author_title:"AI Engineer",author_url:"https://github.com/flybirdgroup",author_image_url:"https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=1615738601,1434436036&fm=26&gp=0.jpg",tags:["CNN","classifier","textCNN"]},prevItem:{title:"Create Virtual Linux by Google \u521b\u5efalinux\u865a\u62df\u673a",permalink:"/blog/2020/3/21/createlinux"},nextItem:{title:"word2vec\u8be6\u89e3",permalink:"/blog/2020/03/18/word2vec"}},o={authorsImageUrls:[void 0]},p=[{value:"\u539f\u7406\u8bb2\u89e3",id:"\u539f\u7406\u8bb2\u89e3",level:2},{value:"\u7ec6\u770b\u7ed3\u6784",id:"\u7ec6\u770b\u7ed3\u6784",level:2},{value:"\u8f93\u5165\u5c42",id:"\u8f93\u5165\u5c42",level:3},{value:"Bi-LSTM",id:"bi-lstm",level:3},{value:"\u6253\u4e71\u6837\u672c",id:"\u6253\u4e71\u6837\u672c",level:2},{value:"\u6280\u672f\u8def\u7ebf",id:"\u6280\u672f\u8def\u7ebf",level:2},{value:"\u67e5\u770b\u662f\u5426\u6709\u7f3a\u5931\u503c",id:"\u67e5\u770b\u662f\u5426\u6709\u7f3a\u5931\u503c",level:2},{value:"\u5206\u6790\u6807\u7b7e\u6570\u636e\u60c5\u51b5",id:"\u5206\u6790\u6807\u7b7e\u6570\u636e\u60c5\u51b5",level:2},{value:"\u67e5\u770b\u6bcf\u4e2a\u6587\u672c\u7684\u957f\u5ea6",id:"\u67e5\u770b\u6bcf\u4e2a\u6587\u672c\u7684\u957f\u5ea6",level:3},{value:"\u5f97\u5230\u53e5\u5b50\u957f\u5ea6",id:"\u5f97\u5230\u53e5\u5b50\u957f\u5ea6",level:2},{value:"jieba\u5206\u8bcd",id:"jieba\u5206\u8bcd",level:2},{value:"\u83b7\u53d6\u505c\u7528\u8bcd\u548c\u8bbe\u7acb\u5206\u8bcd\u51fd\u6570",id:"\u83b7\u53d6\u505c\u7528\u8bcd\u548c\u8bbe\u7acb\u5206\u8bcd\u51fd\u6570",level:2},{value:"\u5efa\u7acb\u6a21\u578b",id:"\u5efa\u7acb\u6a21\u578b",level:2},{value:"Attention\u7f51\u7edc",id:"attention\u7f51\u7edc",level:3},{value:"\u7f51\u7edc\u7ed3\u6784",id:"\u7f51\u7edc\u7ed3\u6784",level:3},{value:"elmo\u5c42",id:"elmo\u5c42",level:3},{value:"\u521b\u5efapadding\u51fd\u6570",id:"\u521b\u5efapadding\u51fd\u6570",level:3},{value:"\u521b\u5efa\u6279\u91cf\u751f\u6210\u5668",id:"\u521b\u5efa\u6279\u91cf\u751f\u6210\u5668",level:3},{value:"\u6784\u5efaELMOTextBiRNN\u7f51\u7edc\u7ed3\u6784",id:"\u6784\u5efaelmotextbirnn\u7f51\u7edc\u7ed3\u6784",level:3},{value:"\u8bbe\u7f6e\u6a21\u578b\u53c2\u6570",id:"\u8bbe\u7f6e\u6a21\u578b\u53c2\u6570",level:3},{value:"\u83b7\u53d6\u6a21\u578b",id:"\u83b7\u53d6\u6a21\u578b",level:3},{value:"\u5212\u5206\u8bad\u7ec3\u96c6,\u6d4b\u8bd5\u96c6",id:"\u5212\u5206\u8bad\u7ec3\u96c6\u6d4b\u8bd5\u96c6",level:2},{value:"\u5efa\u7acb\u8bcd\u5178,\u8bcd\u8bedid\u5316,\u6807\u7b7e\u72ec\u70ed\u7f16\u7801",id:"\u5efa\u7acb\u8bcd\u5178\u8bcd\u8bedid\u5316\u6807\u7b7e\u72ec\u70ed\u7f16\u7801",level:2},{value:"\u8bbe\u7acb\u65e9\u505c",id:"\u8bbe\u7acb\u65e9\u505c",level:2},{value:"\u6d4b\u8bd5\u6a21\u578b",id:"\u6d4b\u8bd5\u6a21\u578b",level:2}],d={toc:p};function m(e){let{components:t,...l}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u539f\u7406\u8bb2\u89e3"},"\u539f\u7406\u8bb2\u89e3"),(0,r.kt)("p",null,"TextAttBiRNN\u662f\u5728\u53cc\u5411LSTM\u6587\u672c\u5206\u7c7b\u6a21\u578b\u7684\u57fa\u7840\u4e0a\u6539\u8fdb\u7684\uff0c\u4e3b\u8981\u662f\u5f15\u5165\u4e86\u6ce8\u610f\u529b\u673a\u5236\uff08Attention\uff09\u3002\u5bf9\u4e8e\u53cc\u5411LSTM\u7f16\u7801\u5f97\u5230\u7684\u8868\u5f81\u5411\u91cf\uff0c\u6a21\u578b\u80fd\u591f\u901a\u8fc7\u6ce8\u610f\u529b\u673a\u5236\uff0c\u5173\u6ce8\u4e0e\u51b3\u7b56\u6700\u76f8\u5173\u7684\u4fe1\u606f\u3002\u5176\u4e2d\u6ce8\u610f\u529b\u673a\u5236\u6700\u5148\u5728\u8bba\u6587 ",(0,r.kt)("a",{parentName:"p",href:"https://arxiv.org/pdf/1409.0473.pdf"},"Neural Machine Translation by Jointly Learning to Align and Translate")," \u4e2d\u88ab\u63d0\u51fa\uff0c\u800c\u6b64\u5904\u5bf9\u4e8e\u6ce8\u610f\u529b\u673a\u5236\u7684\u5b9e\u73b0\u53c2\u7167\u4e86\u8bba\u6587 ",(0,r.kt)("a",{parentName:"p",href:"https://arxiv.org/pdf/1512.08756.pdf"},"Feed-Forward Networks with Attention Can Solve Some Long-Term Memory Problems"),"\u3002"),(0,r.kt)("p",null,"\u6ce8\u610f\u529b\u673a\u5236\u53c2\u8003"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://zhuanlan.zhihu.com/p/37601161"},"\u6df1\u5ea6\u5b66\u4e60\u4e2d\u7684\u6ce8\u610f\u529b\u6a21\u578b")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://zhuanlan.zhihu.com/p/53036028"},"\u6df1\u5ea6\u5b66\u4e60\u6ce8\u610f\u529b\u673a\u5236"))),(0,r.kt)("p",null,"\u8bf7\u6ce8\u610f,\u8fd9\u91cc\u7684\u6ce8\u610f\u529b\u673a\u5236\u4e0ebert\u4e2dtransformer\u7684\u6ce8\u610f\u529b\u673a\u5236\u4e0d\u540c,transformer\u4f1a\u66f4\u52a0\u590d\u6742,\u5927\u5bb6\u53ef\u4ee5\u53c2\u8003\u6211\u5173\u4e8e",(0,r.kt)("a",{parentName:"p",href:"https://github.com/weijiang2009/URun.ResearchPrototype/tree/dev/People/Xiaoxian/NLP%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/Transformer%E7%AC%94%E8%AE%B0"},"transformer")),(0,r.kt)("p",null,"In the paper ",(0,r.kt)("a",{parentName:"p",href:"https://arxiv.org/pdf/1512.08756.pdf"},"Feed-Forward Networks with Attention Can Solve Some Long-Term Memory Problems"),", the ",(0,r.kt)("strong",{parentName:"p"},"feed forward attention")," is simplified as follows,\n",(0,r.kt)("img",{alt:"png",src:n(14034).Z,width:"1146",height:"800"})),(0,r.kt)("p",null,"Function a, a learnable function, is recognized as a feed forward network. In this formulation, attention can be seen as producing a fixed-length embedding c of the input sequence by computing an adaptive weighted average of the state sequence h."),(0,r.kt)("p",null,"c\u5c31\u662f\u6ce8\u610f\u529b,alpha\u5c31\u662f\u6743\u91cd,h\u5c31\u662f\u9690\u542b\u72b6\u6001,alpha\u901a\u8fc7softmax\u8ba1\u7b97,score\u5c31\u662f\u901a\u8fc7h\u8ba1\u7b97\u7684,h\u5c31\u662f\u5f53\u524d\u72b6\u6001\u8f93\u5165\u7684\u8bcd\u8bed\u548c\u4e0a\u4e00\u9690\u542b\u72b6\u6001ht-1\u8ba1\u7b97\u800c\u6765\u7684"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"png",src:n(40670).Z,width:"139",height:"123"})),(0,r.kt)("h2",{id:"\u7ec6\u770b\u7ed3\u6784"},"\u7ec6\u770b\u7ed3\u6784"),(0,r.kt)("p",null,"TextAttBiRNN \u7684\u7f51\u7edc\u7ed3\u6784\n",(0,r.kt)("img",{alt:"png",src:n(23059).Z,width:"832",height:"516"})),(0,r.kt)("h3",{id:"\u8f93\u5165\u5c42"},"\u8f93\u5165\u5c42"),(0,r.kt)("p",null,"\u8f93\u5165\u5c42\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e3a\u53e5\u5b50\u8f93\u5165\u957f\u5ea6\uff0c\u6bcf\u4e2a\u8bcd\u7ecf\u8fc7\u4e00\u4e2aembedding_dim=50\u7684embedding\u77e9\u9635\uff0c\u6700\u7ec8\u8f93\u51fa400\xd750\u7684\u8868\u793a\u77e9\u9635.\u5047\u8bbe\u4e00\u4e2a\u53e5\u5b50\u6709400\u4e2a\u8bcd\u8bed"),(0,r.kt)("h3",{id:"bi-lstm"},"Bi-LSTM"),(0,r.kt)("p",null,"Bi-LSTM\u5c42\u4f5c\u4e3a\u4e00\u79cd\u7279\u5f81\u7f16\u7801\u5c42\uff0c\u8fd9\u5c42\u53ef\u4ee5\u63d0\u53d6\u6bcf\u4e2a\u8bcd\u8bed\u7684\u4e0a\u4e0b\u6587\u7279\u5f81\uff0c\u7136\u540e\u5c06\u53cc\u5411\u7684\u7279\u5f81\u8fdb\u884c\u62fc\u63a5\uff0c\u7136\u540e\u4f9d\u65e7\u5c06\u6bcf\u4e2a\u8bcd\u8bed\u7684\u7279\u5f81\u8fdb\u884c\u8f93\u51fa\uff0c\u56e0\u6b64\u8f93\u51fa\u4e3a400\xd7256\u7684\u7279\u5f81\u77e9\u9635"),(0,r.kt)("p",null,"Attention\u5c42\nAttention\u5c42\u5bf9\u8fd9\u4e2a\u7f51\u7edc\u4e2d\u5bf9\u6bcf\u4e2a\u8bcd\u8bed\u8fdb\u884c\u4e86\u52a0\u6743\u6c42\u548c\uff0c\u8fd9\u4e2a\u6743\u91cd\u662f\u901a\u8fc7\u8bad\u7ec3\u4e0d\u65ad\u8bad\u7ec3\u51fa\u6765\u7684\uff0c\u8fd9\u5c42\u6211\u4eec\u7684\u8f93\u5165x\u4e3a400\xd7256\uff0c\u6211\u4eec\u521d\u59cb\u5316\u6743\u91cd\u77e9\u9635W\u4e3a256\xd71\u7ef4\uff0c\u7136\u540e\u5bf9x\u4e0eW\u8fdb\u884c\u70b9\u4e58\u3001\u5f52\u4e00\u5316\uff08\u516c\u5f0f\u7684\u524d\u4e24\u4e2a\uff09\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f97\u5230400\xd71\u7684\u77e9\u9635a\uff0c\u8fd9\u4e2a\u77e9\u9635\u4ee3\u8868\u7684\u662f\u6bcf\u4e2a\u8bcd\u5bf9\u5e94\u7684\u6743\u91cd\uff0c\u6743\u91cd\u5927\u7684\u8bcd\u4ee3\u8868\u6ce8\u610f\u529b\u5927\u7684\uff0c\u8fd9\u4e2a\u8bcd\u7684\u8d21\u732e\u7a0b\u5ea6\u66f4\u5927\uff0c\u6700\u540e\u5bf9\u6bcf\u4e2a\u8bcd\u8bed\u8fdb\u884c\u52a0\u6743\u5e73\u5747\uff0caT\u4e0ex\u8fdb\u884c\u70b9\u4e58\uff0c\u5f97\u52301\xd7256\uff0c\u8fd9\u662f\u6700\u7ec8\u52a0\u6743\u5e73\u5747\u540e\u8f93\u51fa\u7684\u603b\u7279\u5f81\u5411\u91cf\u3002"),(0,r.kt)("p",null,"\u8f93\u51fa\u5c42\n\u4e0e\u6211\u4e4b\u524dtextCNN\u505a\u4e2d\u6587\u65b0\u95fb\u5206\u7c7b\u5b9e\u9a8c\u5dee\u4e0d\u591a\uff0c\u4f7f\u7528\u5168\u8fde\u63a5\u5c42\uff0csoftmax\u4f5c\u4e3a\u6fc0\u6d3b\u51fd\u6570\u8fdb\u884c\u8f93\u51fa\u3002"),(0,r.kt)("p",null,"demo\u9879\u76ee: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/flybirdgroup/sentiment_analysis"},"\u60c5\u611f\u5206\u6790")),(0,r.kt)("h1",{id:"\u5bfc\u5165\u5de5\u5177\u5305"},"\u5bfc\u5165\u5de5\u5177\u5305"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import pandas as pd\nimport jieba_fast as jieba\nfrom tensorflow.keras.layers import Layer\nfrom tensorflow.keras import backend as K\nfrom tensorflow.keras import initializers,regularizers,constraints\nfrom tensorflow.keras import Input,Model,models\nfrom tensorflow.keras.layers import Embedding, Dense, Conv1D, GlobalMaxPooling1D, Concatenate, Dropout\nfrom tensorflow.keras import Input,Model\nfrom tensorflow.keras.layers import Embedding,Dropout,Dense,Bidirectional,LSTM\nfrom tensorflow.keras.models import load_model\nfrom elmoformanylangs import Embedder\nimport numpy as np\nfrom tensorflow.keras.utils import plot_model\nfrom sklearn.model_selection import train_test_split\nfrom tensorflow.keras.utils import to_categorical\nfrom tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint\nfrom pandarallel import pandarallel\npandarallel.initialize()\nfrom tensorflow.keras.preprocessing.text import Tokenizer\n")),(0,r.kt)("h1",{id:"\u8bfb\u53d6\u6570\u636e"},"\u8bfb\u53d6\u6570\u636e"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df = pd.read_csv('./data/sentiment_analysis_data.csv',sep=' ')\ndf\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"png",src:n(59326).Z,width:"662",height:"387"})),(0,r.kt)("h2",{id:"\u6253\u4e71\u6837\u672c"},"\u6253\u4e71\u6837\u672c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df = df.sample(frac=1).reset_index(drop=True)\n")),(0,r.kt)("h1",{id:"\u5efa\u6a21\u601d\u8def"},"\u5efa\u6a21\u601d\u8def"),(0,r.kt)("h2",{id:"\u6280\u672f\u8def\u7ebf"},"\u6280\u672f\u8def\u7ebf"),(0,r.kt)("p",null,"\u5206\u4e24\u79cd\u79cd\u60c5\u51b5,\u597d\u8bc4,\u8d1f\u8bc4,\u4e2d\u8bc4\n\u8ba1\u7b97\u8def\u7ebf:\n1 \u4f7f\u7528TextCNN\u5bf9\u6bcf\u4e2a\u53e5\u5b50\u7c7b\u4f3cn-gram\u5904\u7406"),(0,r.kt)("p",null,"2 \u4f7f\u7528RNN"),(0,r.kt)("p",null,"3 \u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528attention\u673a\u5236\u505a\u60c5\u611f\u5224\u65ad,\u5bf9\u8bcd\u8fdb\u884cword2vec,\u6216\u8005elmo embedding,\u53ef\u6dfb\u52a0bi-lstm\u83b7\u53d6\u4e0a\u4e0b\u6587\u4fe1\u606f"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.xn--gmqr38alogxt2a.net/blog/Attention"},"Attention\u539f\u7406\u8bf7\u53c2\u8003")),(0,r.kt)("h2",{id:"\u67e5\u770b\u662f\u5426\u6709\u7f3a\u5931\u503c"},"\u67e5\u770b\u662f\u5426\u6709\u7f3a\u5931\u503c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df.info()\n")),(0,r.kt)("h2",{id:"\u5206\u6790\u6807\u7b7e\u6570\u636e\u60c5\u51b5"},"\u5206\u6790\u6807\u7b7e\u6570\u636e\u60c5\u51b5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"label_dict = {'-1':'\u8d1f\u8bc4','0':'\u4e2d\u8bc4','1':'\u6b63\u8bc4'}\n\ndf['label']=df['label'].apply(lambda x: label_dict[str(x)] )\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df.tail()\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"png",src:n(33036).Z,width:"648",height:"255"})),(0,r.kt)("h3",{id:"\u67e5\u770b\u6bcf\u4e2a\u6587\u672c\u7684\u957f\u5ea6"},"\u67e5\u770b\u6bcf\u4e2a\u6587\u672c\u7684\u957f\u5ea6"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df['txt_num'] = df['txt'].agg(lambda x: len(x))\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df.agg({'txt_num':'mean'})\n")),(0,r.kt)("h2",{id:"\u5f97\u5230\u53e5\u5b50\u957f\u5ea6"},"\u5f97\u5230\u53e5\u5b50\u957f\u5ea6"),(0,r.kt)("p",null,"\u6240\u4ee5\u6839\u636e\u6570\u636e,\u5f97\u51fa\u6211\u4eec\u4f1a\u8bbe\u7f6emaxlen= 40\u5de6\u53f3"),(0,r.kt)("h2",{id:"jieba\u5206\u8bcd"},"jieba\u5206\u8bcd"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"from pandarallel import pandarallel\npandarallel.initialize()\n")),(0,r.kt)("h2",{id:"\u83b7\u53d6\u505c\u7528\u8bcd\u548c\u8bbe\u7acb\u5206\u8bcd\u51fd\u6570"},"\u83b7\u53d6\u505c\u7528\u8bcd\u548c\u8bbe\u7acb\u5206\u8bcd\u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"stopwords = pd.read_csv('./data/stopwords.txt',sep='\\t',index_col=False,quoting=3,encoding='utf-8')\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"def split_words(X):\n    result = [i for i in jieba.lcut(X) if i not in stopwords]\n    result = ' '.join(result)\n    return result\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df['txt']=df['txt'].parallel_apply(split_words)\n")),(0,r.kt)("h2",{id:"\u5efa\u7acb\u6a21\u578b"},"\u5efa\u7acb\u6a21\u578b"),(0,r.kt)("h3",{id:"attention\u7f51\u7edc"},"Attention\u7f51\u7edc"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'class Attention(Layer):\n    def __init__(self, step_dim,\n                 W_regularizer=None, b_regularizer=None,\n                 W_constraint=None, b_constraint=None,\n                 bias=True, **kwargs):\n        self.supports_masking = True\n        self.init = initializers.get(\'glorot_uniform\')\n\n        self.W_regularizer = regularizers.get(W_regularizer)\n        self.b_regularizer = regularizers.get(b_regularizer)\n\n        self.W_constraint = constraints.get(W_constraint)\n        self.b_constraint = constraints.get(b_constraint)\n\n        self.bias = bias\n        self.step_dim = step_dim\n        self.features_dim = 0\n\n        super(Attention, self).__init__(**kwargs)\n\n    def build(self, input_shape):\n        assert len(input_shape) == 3\n\n        self.W = self.add_weight(shape=(input_shape[-1],),\n                                 initializer=self.init,\n                                 name=\'{}_W\'.format(self.name),\n                                 regularizer=self.W_regularizer,\n                                 constraint=self.W_constraint)\n        self.features_dim = input_shape[-1]\n\n        if self.bias:\n            self.b = self.add_weight(shape=(input_shape[1],),\n                                     initializer=\'zero\',\n                                     name=\'{}_b\'.format(self.name),\n                                     regularizer=self.b_regularizer,\n                                     constraint=self.b_constraint)\n        else:\n            self.b = None\n\n        self.built = True\n    \n    def compute_mask(self,input,input_mask=None):\n        #do not pass the mask to the next layers\n        return None\n    \n    def call(self,x,mask=None):\n        features_dim = self.features_dim\n        step_dim = self.step_dim\n        \n        #K.reshape(x,(-1,features_dim))\u91cc\u9762-1\u53ef\u4ee5\u60f3\u8c61\u6210\u4e00\u884c,features_dim\u53d8\u6210\u4e00\u884c\u6709features_dim\u7ef4\u77e9\u9635(1*dim\u7ef4),K.reshape(self.W, (features_dim, 1)),\u53d8\u6210\u77e9\u9635(dim\u7ef4*self.W)features_dim\u884c\u548c1\u7ef4\n        e = K.reshape(K.dot(K.reshape(x, (-1, features_dim)), K.reshape(self.W, (features_dim, 1))), (-1, step_dim))  \n        # \u8fd9\u91cc\u4e5f\u53ef\u4ee5\u7528\u53e6\u5916\u4e00\u79cd\u8868\u793a\u65b9\u5f0f\n#         e = K.reshape(K.dot(K.reshape(x,(1,-1)),K.reshape(self.W,(-1,1))),(-1,1))\n        # \u5176\u5b9e\u5c31\u662f\u5168\u8fde\u63a5\u7684\u77e9\u9635\u76f8\u4e58 e = K.dot(x, self.W)\n        if self.bias:\n            e += self.b\n        e = K.tanh(e) # \u6fc0\u6d3b\u51fd\u6570\n        a = K.exp(e) # \u53bb\u6307\u6570\n        # apply mask after the exp. will be re-normalized next\n        if mask is not None:\n            # cast the mask to floatX to avoid float64 upcasting in theano\n            a *= K.cast(mask, K.floatx()) # \u8f6c\u6362\u6210floatx\u7c7b\u578b\n        # in some cases especially in the early stages of training the sum may be almost zero\n        # and this results in NaN\'s. A workaround is to add a very small positive number \u03b5 to the sum.\n        a /= K.cast(K.sum(a, axis=1, keepdims=True) + K.epsilon(), K.floatx()) # softmax\u51fd\u6570,\u5f97\u5230\u6743\u91cd\u77e9\u9635\n        a = K.expand_dims(a) # \u53d8\u6210(dim,1),\u8fd9\u6837\u53ef\u4ee5\u4e0ex\u8fdb\u884c\u52a0\u6743\u5c31\u548c\u5f97\u5230context\n        \n        c = K.sum(a*x,axis=1) #\u6743\u91cd\u4e0ehidden\u4fe1\u606f\u52a0\u6743\u5c31\u548c\u5f97\u5230context,\u4e5f\u5c31\u662f\u6211\u4eec\u7684\u6ce8\u610f\u529b\n        return c\n    def compute_output_shape(self, input_shape):\n        return input_shape[0], self.features_dim  \n    \n    def get_config(self):\n        config = {\n                "step_dim":self.step_dim,\n                 "W_regularizer":self.W_regularizer, "b_regularizer":self.b_regularizer,\n                 "W_constraint":self.W_constraint, "b_constraint":self.b_constraint,\n                 "bias":self.bias}\n        base_config = super(Attention, self).get_config()\n        return dict(list(base_config.items()) + list(config.items()))\n')),(0,r.kt)("h3",{id:"\u7f51\u7edc\u7ed3\u6784"},"\u7f51\u7edc\u7ed3\u6784"),(0,r.kt)("h3",{id:"elmo\u5c42"},"elmo\u5c42"),(0,r.kt)("p",null,"\u54c8\u5de5\u5927\u5f00\u53d1\u7684\u52a8\u6001\u8bcd\u5411\u91cf",(0,r.kt)("a",{parentName:"p",href:"https://github.com/HIT-SCIR/ELMoForManyLangs"},"elmo")),(0,r.kt)("p",null,"elmo\u539f\u7406\u53ef\u53c2\u8003",(0,r.kt)("a",{parentName:"p",href:"https://www.jianshu.com/p/2fff53696fac"},"\u94fe\u63a5")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"e = Embedder('./zhs.model/')\n")),(0,r.kt)("h3",{id:"\u521b\u5efapadding\u51fd\u6570"},"\u521b\u5efapadding\u51fd\u6570"),(0,r.kt)("p",null,"\u8d85\u8fc7\u53e5\u5b50\u957f\u5ea6\u5c31\u622a\u53d6,\u4e0d\u591f\u5c31\u8865\u7a7a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"def pad_sent(x, max_len):\n    if len(x)>max_len:\n        return x[:max_len]\n    else:\n        return x+['']*(max_len-len(x))\n")),(0,r.kt)("h3",{id:"\u521b\u5efa\u6279\u91cf\u751f\u6210\u5668"},"\u521b\u5efa\u6279\u91cf\u751f\u6210\u5668"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"def batch_generator(x, y, batch_size=64):\n    n_batches_per_epoch = len(x)//batch_size\n    for i in range(n_batches_per_epoch):\n        x_batch = np.array(e.sents2elmo([pad_sent(sent,40) for sent in x[batch_size*i:batch_size*(i+1)]]))\n        y_batch = y[batch_size*i:batch_size*(i+1),:]\n        yield x_batch, np.array(y_batch)\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"def predict_generator(x, batch_size=1): #\u9884\u6d4b\n    n_batches_per_epoch = len(x)//batch_size\n    for i in range(n_batches_per_epoch):\n        x_batch = np.array(e.sents2elmo([pad_sent(sent,40) for sent in x[batch_size*i:batch_size*(i+1)]]))\n        yield x_batch\n")),(0,r.kt)("h3",{id:"\u6784\u5efaelmotextbirnn\u7f51\u7edc\u7ed3\u6784"},"\u6784\u5efaELMOTextBiRNN\u7f51\u7edc\u7ed3\u6784"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"class ELMOTextBiRNN(object):\n    def __init__(self,maxlen,max_features,embedding_dims,class_num=3,last_activation='softmax'):\n        self.maxlen = maxlen\n        self.max_features = max_features\n        self.embedding_dims = embedding_dims\n        self.class_num = class_num\n        self.last_activation = last_activation\n#     def get_model(self):\n#         embedding = Input((self.maxlen, self.embedding_dims,)) # \u8f93\u5165\u9884\u8bad\u7ec3\u7684\u8bcd\u5411\u91cf\n#         convs = [] \n#         for kernel_size in [3,4,5]: #\u8bbe\u5b9afilter\u5927\u5c0f\n#             c = Conv1D(128,kernel_size,activation='relu')(embedding)\n#             c = GlobalMaxPooling1D()(c)\n#             convs.append(c)\n#         x = Concatenate()(convs)\n#         output = Dense(self.class_num,activation=self.last_activation)(x)\n#         model = Model(inputs=embedding,outputs=output)\n#         return model\n    \n    def get_model(self):\n        embedding = Input((self.maxlen,self.embedding_dims,))\n        x = Bidirectional(LSTM(128,return_sequences=True))(embedding)\n        x = Attention((self.maxlen))(x)\n        output = Dense(self.class_num,activation=self.last_activation)(x)\n        model = Model(embedding,output)\n        return model        \n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"tokenizer = Tokenizer()\ntokenizer.fit_on_texts(df['txt'].values)\nvocab = tokenizer.word_index\nlen(vocab)+1\n")),(0,r.kt)("h3",{id:"\u8bbe\u7f6e\u6a21\u578b\u53c2\u6570"},"\u8bbe\u7f6e\u6a21\u578b\u53c2\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"maxlen = 40\nbatch_size = 32\nmax_features = len(vocab)+1\nembedding_dims = 1024\nepochs = 9\n")),(0,r.kt)("h3",{id:"\u83b7\u53d6\u6a21\u578b"},"\u83b7\u53d6\u6a21\u578b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"model = ELMOTextBiRNN(maxlen,max_features,embedding_dims).get_model()\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"plot_model(model,show_shapes=True)\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"png",src:n(33133).Z,width:"531",height:"395"})),(0,r.kt)("h2",{id:"\u5212\u5206\u8bad\u7ec3\u96c6\u6d4b\u8bd5\u96c6"},"\u5212\u5206\u8bad\u7ec3\u96c6,\u6d4b\u8bd5\u96c6"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"x_train,x_test,y_train,y_test = train_test_split(df['txt'].values,df['label'])\n")),(0,r.kt)("h2",{id:"\u5efa\u7acb\u8bcd\u5178\u8bcd\u8bedid\u5316\u6807\u7b7e\u72ec\u70ed\u7f16\u7801"},"\u5efa\u7acb\u8bcd\u5178,\u8bcd\u8bedid\u5316,\u6807\u7b7e\u72ec\u70ed\u7f16\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"def encode_category_one_hot(y_train,y_test): \n    from tensorflow.keras.utils import to_categorical\n    set(y_train)\n    categories = set(y_train)\n    categories\n    cat_to_id = dict(zip(categories, range(len(categories))))\n    y_train_id = [cat_to_id[i] for i in y_train]\n    y_test_id = [cat_to_id[i] for i in y_test]\n    cat_to_id\n    y_train_one_hot = to_categorical(y_train_id)\n    y_test_one_hot = to_categorical(y_test_id)\n    return y_train_one_hot,y_test_one_hot,cat_to_id\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"y_train_one_hot,y_test_one_hot,cat_to_id = encode_category_one_hot(y_train,y_test)\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"x_train = sentences_list(x_train)\nx_test = sentences_list(x_test)\n")),(0,r.kt)("h2",{id:"\u8bbe\u7acb\u65e9\u505c"},"\u8bbe\u7acb\u65e9\u505c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"my_callbacks = [ModelCheckpoint('.ELMO_birnn_model.h5'),\n                EarlyStopping(monitor='accuracy',patience=2,mode='max')]\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"model = ELMOTextBiRNN(40,max_features,1024).get_model()\nmodel.compile('adam','categorical_crossentropy',metrics=['accuracy'])\n")),(0,r.kt)("h2",{id:"\u6d4b\u8bd5\u6a21\u578b"},"\u6d4b\u8bd5\u6a21\u578b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"text = '\u4eca\u5929 \u5929\u6c14 \u5f88 \u6674\u6717 \u5904\u5904 \u6709 \u9633\u5149 \u6709 \u9633\u5149'\nsentence = [['%s'%text]]\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"cat_to_id\n")),(0,r.kt)("p",null,"  {'\u8d1f\u8bc4': 0, '\u6b63\u8bc4': 1, '\u4e2d\u8bc4': 2}"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"sentence\n")),(0,r.kt)("p",null,"[","['\u4eca\u5929 \u5929\u6c14 \u5f88 \u6674\u6717 \u5904\u5904 \u6709 \u9633\u5149 \u6709 \u9633\u5149']","]"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"model.predict_generator(predict_generator(sentence, batch_size=1),steps=1)\n")),(0,r.kt)("p",null,"array([","[0.21561107, 0.600974  , 0.18341494]","], dtype=float32)"))}m.isMDXComponent=!0},59326:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/1-91054ddc8aa1c6bf4c7b6bb3693edfac.png"},33036:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/2-60216825d3aa4fa46ac03f1c6fb73b74.png"},14034:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/FeedForwardAttention-c7c691aa52a21ef9b61f9a885f985240.png"},40670:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,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"},33133:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/output_47_0-ff55d84af1667ad834bf6ae26949cc44.png"},23059:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/text-attn-birnn-f1dc0d41478bbeb69aae3d3e89170226.png"}}]);